# RB-TnSeq
Scripts for Estimating Mutant Fitness By Sequencing Randomly Barcoded Transposon Insertion Sequencing (RB-TnSeq)

This code repository includes scripts for processing sequencing data for randomly barcoded transposon insertion sequencing (RB-TnSeq) as originally described in Deutschbauer et al., doi: 10.1128/mBio.00306-1 http://mbio.asm.org/content/6/3/e00306-15.full

Original code for RB-TnSeq analysis described in Deutschbauer et al. can be found at (bitbucket.org/berkeleylab/feba/). 

This code repository includes a mix of slightly modified and original Perl scripts from Deutschbauer et al. and several original Python scripts used for estimating mutant fitness by Bar-Seq, where transposon-specific bar codes were already determined using scripts from bitbucket.org/berkeleylab/feba/. If barcode information corresponding to transposon insertions is not already determined for a given RB-TnSeq library, one must first process Tn-Seq data using MapTnSeq.pl and DesignRandomPool.pl from the feba repository. Additionally, python scripts are built to handle data with 3 replicates of each condition; modifications may be necessary if 3 replicates are not used.

## The stages in creating fitness estimates by Bar-Seq are:
<ins>**1_Multicodes.pl**</ins> -- Identifies barcode in each read of a demultiplexed BarSeq fastq file; makes a table of how often each barcode was seen in the sample (this is the original script from https://bitbucket.org/berkeleylab/feba/src/master/bin/MultiCodes.pl).

<ins>**2_combineBarSeq.pl**</ins> -- Merges the table of counts from MultiCodes.pl with the transposon pool definition from DesignRandomPool.pl to make a table of how often each individual transposon mutant (strain) was seen (this is the original script from https://bitbucket.org/berkeleylab/feba/src/master/bin/combineBarSeq.pl).

<ins>**3_BarSeqR.pl**</ins> -- Combines multiple files of combineBarSeq.pl output with genes (%GC) table from RegionGC.pl function to make a single large table (all.poolcount file) (this is the original script from https://bitbucket.org/berkeleylab/feba/src/master/bin/BarSeqR.pl; note that the ‘noR’ argument is true for the analyses described here).

<ins>**4_BarSeqProc_loadExps.py**</ins> -- Loads the all.poolcount file generated by 3_BarSeqR.pl, groups insertions according to gene locus, eliminates counts not found within a gene CDS, and eliminates transposon counts for individual strains that have fewer than three insertions in the baseline sample.

<ins>**5_BarSeqProc_analyzeExp.py**</ins> -- Loads the in3genes.csv file generated by 4_BarSeqProc_loadExps.py, eliminates genes that have fewer than thirty total insertion reads in the baseline sample. A normalized gene fitness score and t-like statistic is calculated for each gene, according to the methods used in Wetmore, Kelly M., et al. MBio (2015). Modifications are fitness normalization used only the approach described for small gene scaffolds and no gene end count trimming was performed.

## Data processing and visualization scripts:
<ins>**6_Combined_30_Count_Replicates_List.py**</ins>-- This function takes the _<30_Unused_BL_genes.csv files from the three replicates and merges them into one file, eliminating any duplicates from the list. This is an essential step prior to generating the replicates table, since if a gene doesn't have a fitness value for all replicates, this file is used to trim it from the dataset.

<ins>**7_Replicates_Table.py**</ins> -- This function takes the merged <30_Unused_BL_genes.csv output file generated by 6_Combined_30_Count_Replicates_List.py function and then the three replicate fitness files for a given enrichment condition generated as output from the 5_BarSeqProc_analyzeExp.py function and merges the fitness scores for each gene into one ‘_fitness_summary’ file. Mean fitness scores are provided and a two-tailed one sample t-test against a null fitness of 0 is performed, where p-values are corrected for multiple testing using the positive false discovery rate (pFDR) and pFDR q values are adjusted for monotonicity.

<ins>**8_Fitness_Compare.py**</ins> -- This will take two different .Statistics.csv files generated from the 7_Replicates_Table.py function as input and trim the rows to contain the same list of analyzed genes and generate a new file with the individual fitness and mean values for each condition that is compared. Mean fitness scores are compared using a two-tailed two sample t-test, where p-values are corrected for multiple testing using the positive false discovery rate (pFDR) and pFDR q values are adjusted for monotonicity.

<ins>**9_Summary_annotate.py**</ins> -- This function reads through all the old locus tags (PP_xxx format) in # Locus_Tag column of the _Summary output file from the 8_Fitness_Compare.py function and matches it with the appropriate gene name, new locus tag, and descriptor for qualified genes, as found in the updated KT2440 annotation file (GCF_000007565.2_ASM756v2_feature_table). If no match is found, the function fills in blank spaces at the corresponding location in the new output file.

<ins>**10_heatmap.py**</ins> -- Generate a heatmap showing fitness values for the genes listed in the first column of the input file. The enrichment conditions to include in the heatmap are listed in the second column of the input file (The glucose only baseline is added automatically to the heatmap). This uses the Annotated_summary files generated by 9_Summary_annotate to abstract fitness values.

<ins>**11_2D_Graph.py**</ins> -- Generate a scatterplot using the comparison summary data from an output file generated by 9_Summary_annotate.py 

This is research software that has undergone limited testing and run only on a local MacOS machine. Please be careful before using these scripts with your own code.

Andrew J. Borchert & Alissa Bleem, National Renewable Energy Laboratory, February 2022

## OTHER REQUIRED FILES AND SCRIPTS
<ins>**FEBA_Utils.pm**</ins> – From bitbucket.org/berkeleylab/feba/ Contains functions relied upon by 3_BarSeqR.pl

<ins>**FindGene.pm**</ins> – From bitbucket.org/berkeleylab/feba/

<ins>**Compounds.pm**</ins> – From bitbucket.org/berkeleylab/feba/

<ins>**BarSeq.tsv**</ins> – Experiment metadata file

<ins>**Compounds.tsv**</ins> – From bitbucket.org/berkeleylab/feba/ Compounds type list file used for ‘Conditions’ columns in Experiment metadata file

<ins>**media**</ins> – From bitbucket.org/berkeleylab/feba/ Media type list file used for ‘Media’ column in Experiment metadata file 

<ins>**mixes**</ins> – From bitbucket.org/berkeleylab/feba/ Mixes type list file for mixes descriptions in media compositions

<ins>**KT2440_pool.txt**</ins> – From http://morgannprice.org/FEBA/Putida/ File describing barcode to transposon insertion information generated by DesignRandomPool.pl

<ins>**KT2440_genes.gc**</ins> – From http://morgannprice.org/FEBA/Putida/ KT2440 genes.gc table using RegionGC.pl GCF_000007565.2_ASM756v2_feature_table_trimmed.txt – Updated KT2440 gene annotation file

<ins>**index.txt**</ins> –File providing the Index ID to Index Sequence information

## MORE DETAILS ON THE MAIN SCRIPTS
<ins>**1_Multicodes.pl**</ins> —This is code from the FEBA repository (bitbucket.org/berkeleylab/feba/) copied here for convenience and modified slightly to eliminate the If -minQuality >0 description (lines 54-59 in original)<br>
<ins>Usage:</ins>
<blockquote>
PATH/MultiCodes.pl -out {PATH/out_prefix} -index {index_name} {.fastq_file} -preseq {sequence} -postseq {sequence} -nPreExpected {#} >& {PATH/_Multicodes.log} </blockquote>
<ins>Input:</ins>
<blockquote>
-index indicates the sequence of the indexing primer, e.g. IT001 = ATCACG<br>
-preseq is the 9 nt upstream of the barcode<br>
-postseq is the 9 nt downstream of the barcode<br>
-nPreExpected is the number of nt before preseq <br>
-MultiCodes.log saves the log file of output that is printed to the terminal when running the program, to the designated path </blockquote>
<ins>Output:</ins>
<blockquote>
-{out_prefix}.codes<br>
-{out_prefix}.close<br>
-{out_prefix}.count </blockquote> </p>
	
<ins>**2_combineBarSeq.pl**</ins> -- This is code from the FEBA repository (bitbucket.org/berkeleylab/feba/) copied here for convenience and modified to include a more detailed description of its use.<br>
<ins>Usage:</ins>
<blockquote>
PATH/combineBarSeq.pl -out {PATH/.codes_file} {PATH/gene_pool.txt_file} {Output_Name} >& {PATH/combineBarSeq.log} </blockquote>
<ins>Input:</ins>
<blockquote>
-gene_pool.txt is the .txt file generated by DesignRandomPool.pl. This file was already prepared for the KT2440 transposon library (ML5) (labelled ‘pool’ at http://morgannprice.org/FEBA/Putida/)</blockquote>
<ins>Output:</ins>
<blockquote>
-{codes_file_prefix}.poolcount<br>
-{codes_file_prefix}.colsum</blockquote>

<ins>**3_BarSeqR.pl**</ins> — This code is modified slightly from the original found in the FEBA repository (bitbucket.org/berkeleylab/feba/) to include a more detailed description of its use.<br>
<ins>Usage:</ins>
<blockquote>
/PATH/BarSeqR.pl -org {org_name} -indir {inputs_PATH} -exps {BarSeq.tsv} -genes {genes.GC} -pool {poolcount_file} -noR -outdir {PATH} -metadir {PATH} >& {PATH/BarSeqR.log}</blockquote>
<ins>Inputs:</ins>
<blockquote>
-org -- organism name (This must match the organism’s name provided in the Metadata file)<br>
-indir -- input directory, must include genes, exps, and poolcount files (below) as well as FEBA_utils.pm FindGene.pm Perl modules. Modules can be found at https://bitbucket.org/berkeleylab/feba/src/master/<br>
-exps -- experiment metadata file<br>
-genes -- genes.gc table (You can generate a genes.gc file from a .fna assembly file from NCBI using RegionGC.pl)<br>
-pool -- Combined Multicodes file (combineBarSeq.pl output)<br>
-noR -- skips invoking the FEBA.R step associated with this program <br>
-outdir -- Directory where output will be stored<br>
-metadir -- Directory where the compounds, media, and mixes metadata can be found (available at https://bitbucket.org/berkeleylab/feba/src/master/metadata/).<br> 
PATH/{file}.log  (Optional input) -- Directory and filename for printed output from program</blockquote>
<ins>Outputs:</ins>
<blockquote>
-all.poolcount file -- with columns “barcode”, “rcbarcode” (random complement), “scaffold” (organism sequence scaffold used e.g. NC_015976.1), “strand” (+/-), “pos” (bp position number of barcode in genome), “locusId” (locus tag where barcode inserted), “f” (fractional distance along gene for barcode insertion), barcode counts for each experiment specified in FEBA_BarSeq.tsv.<br>
-exp -- copy of experiments file used as input<br>
-genes -- copy of genes.gc file used as input<br>
-pool -- copy of pool file used as input<br>
PATH/{file}.log  (Optional) -- Directory and filename for printed output from program</blockquote>
	
<ins>**4_BarSeqProc_loadExps.py**</ins> —This code was written by Alissa Bleem (NREL) and Andrew J. Borchert (NREL). Breaks if using less than or more than 3 biological replicates.<br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/4_BarSeqProc_loadExps.py {PATH/all.poolcount_file} {baseline_condition} {Test Conditions} </blockquote>
<ins>Inputs:</ins>
<blockquote>
-all.poolcount file is file generated by BarSeqR.pl function<br>
-baseline condition chosen as a reference (1, 2, 3, etc.)<br>
-Test Conditions Chosen '4,5,6,etc.''   NOTE. This is the set number as it appears in the .poolcount file. Not the neccisarily particular condition index. So, third set in would be '3'. Separate condition set numbers with commas e.g. '2,3,4,5' </blockquote>
<ins>Outputs:</ins>
<blockquote>
-{baseline condition}{replicates}_counts-in-genes.csv—Files made from extracting rows from the all.poolcount file where the barcoded transposon insertion falls within a gene and breaking apart by replicates A-C<br>
-{baseline condition}{replicates}_in3genes.csv—File made from extracting rows from the {baseline condition}{replicate}_counts-in-genes.csv file, where >= 3 distinct transposon insertions exist for each strain in the T=0 baseline condition. This breaks apart into sets based upon replicate A,B, or C </blockquote>
	
5_BarSeqProc_analyzeExp.py—This code was written by Alissa Bleem (NREL) and Andrew J. Borchert (NREL).<br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/5_BarSeqProc_analyzeExp.py {PATH/1_M9A_in3genes.csv_file} </blockquote>
<ins>Input:</ins>
<blockquote>
-in3genesFile is the file generated from the 4_BarSeqProc_loadExps.py function.</blockquote>
<ins>Outputs:</ins>
<blockquote>
-{baseline_condition}_<30_Unused_BL_genes.csv is a file listing all the genes that DID NOT satisfy the baseline counts > 30 for each gene condition <br>
-{baseline_condition}_GenesUsedforAnalysis.csv is a file listing all the genes that DID satisfy the baseline counts > 30 for each gene condition <br>
-{condition_tested}_Unused_0ct_Exp_genes.csv is a file listing all the genes from the GenesUsedforAnalysis.csv file where there was a 0ct for that gene in the designated condition tested.  This file will not be generated if no genes have a zero count in the condition tested. <br>
-{condition_tested}_GenesUsedforAnalysis_no_ZeroSums.csv lists all genes from the GenesUsedforAnalysis.csv file where, for the analyzed condition, 1 or more counts were observed in the given gene <br>
-{condition_tested}_allAnalyzedGenes.csv provides the following data for all genes listed in the GenesUsedforAnalysis_no_ZeroSums.csv file <br>
geneName - old locus tag designation for a gene (PP_xxxx) <br>
normGeneFit - the normalized gene fitness of the gene (condition tested vs. baseline condition), as calculated according to Wetmore, Kelly M., et al. MBio (2015)<br>
tStat_abs - the t-like statistic, as calculated according to Wetmore, Kelly M., et al. MBio (2015) </blockquote>
	
6_Combined_30_Count_Replicates_List.py—This code was written by Andrew J. Borchert (NREL).<br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/6_Combined_30_Count_Replicates_List.py {PATH_input_output_Files} {output_filename} {replicate_A_<30_Unused_BL_genes.csv} {replicate_B_<30_Unused_BL_genes.csv} {replicate_C_<30_Unused_BL_genes.csv} <br>
NOTE, the < must be escaped in Bash scripting using a \ </blockquote>
<ins>Inputs:</ins>
<blockquote>
-{replicate_A_<30_Unused_BL_genes.csv} The genes from replicate A that did not meet the >30 counts in a gene cutoff condition
-{replicate_B_<30_Unused_BL_genes.csv} 
-{replicate_C_<30_Unused_BL_genes.csv} </blockquote>
<ins>Outputs:</ins>
<blockquote>
{output_filename} is a csv file with a list of all the unused (<30 count) genes from each of the baseline replicates, where duplicate names are deleted from the list. </blockquote>
																																	 
7_Replicates_Table.py—This code was written by Andrew J. Borchert (NREL). <br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/7_Replicates_Table.py {PATH/merged_<30_Unused_BL_genes.csv} {PATH to fitness files} {Enrichment_Fitness_A_File} {Enrichment_Fitness_B_File} {Enrichment_Fitness_C_File} </blockquote>
<ins>Inputs:</ins>
<blockquote>
-{PATH/merged_<30_Unused_BL_genes.csv} - The file generated by 6_Combined_30_Count_Replicates_List.py, which is a csv file with a list of all the unused (<30 count) genes from each of the baseline replicates, where duplicate names are deleted from the list.<br>
-{Enrichment_Fitness_A_File} - The File generated from 5_BarSeqProc_analyzeExp.py that calculates gene fitness scores for the given replicate A enrichment condition<br>
-{Enrichment_Fitness_B_File} <br>
-{Enrichment_Fitness_C_File} </blockquote>
<ins>Outputs:</ins>
<blockquote>
-{enrichment_title}_trimmed_genes.csv is a csv file with a list of all the unused genes (0 count in at least one enrichment replicate for the gene) in the analysis. <br>
-{enrichment_title}_Fitness_Summary.csv is a csv file with a list of all the merged gene fitness data along with the mean fitness calculated for each gene between the three replicates. <br>
-{enrichment_title}_Statistics.csv is a csv file with the same merged gene fitness data along with the mean fitness calculated for each gene between the three replicates as in the _Fitness_Summary file. Additionally, the t-score and p-value from a two-tailed one sample t-test is provided <br>
-{enrichment_title}_Statistics_sorted.csv is a csv file with the same data as in the _Fitness_Summary file. Additionally, the p-values were sorted lowest to highest and the positive benjamini-hochburg correction for multiple testing was used to determine corresponding q-values and this column was added to the table. Finally, a column where q-values were adjusted for monotonicity according to the method described by Yekutieli and Benjamini, 1999 is provided. </blockquote>
	
8_Fitness_Compare.py—This code was written by Andrew J. Borchert (NREL). <br>
<ins>Usage:</ins>
<blockquote>
PATH/8_Fitness_Compare.py {PATH/Condition_1_Fitness_Summary.csv} {'Condition_1_Label’} {PATH/Condition_2_Fitness_Summary.csv} {'Condition_2_Label’} </blockquote>
<ins>Inputs:</ins>
<blockquote>
-{PATH/Condition_1_Fitness_Summary.csv} - Fitness summary file for the first enrichment condition, as generated by the 7_Replicates_Table.py function <br>
-{PATH/Condition_2_Fitness_Summary.csv} - Fitness summary file for the second enrichment condition, as generated by the 7_Replicates_Table.py function </blockquote>
<ins>Outputs:</ins>
<blockquote>
-{Condition_1}_v_{Condition_2}_trimmed_genes.csv - a csv file with a list of all the unused genes (not found in both _Fitness_Summary.csv files being compared) in the analysis. The enrichment condition title is abstracted from the input condition labels. <br>
-{Condition_1}_v_{Condition_2}_Summary.csv - a csv file with a list of all the merged gene fitness data along with the mean fitness calculated for each gene between the three replicates for each condition. Additionally, the t-score and p-value from a two-tailed two sample t-test is provided. The positive FDR (pFDR) correction for multiple testing was used to determine corresponding q-values and this column was added to the table. Finally, a column where the q-values were adjusted for monotonicity according to the method described by Yekutieli and Benjamini, 1999 is provided. </blockquote>
	
9_Summary_annotate.py—This code was written by Andrew J. Borchert (NREL). <br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/9_Summary_annotate.py {PATH/C1_v_C2_Summary.csv} {PATH/feature_table.txt} {output_filename}  </blockquote>
<ins>Inputs:</ins>
<blockquote>
-{PATH/C1_v_C2_Summary.csv} - The statistics summary file generated by the 8_fitness_compare.py function <br>
-{PATH/feature_table.txt} - The annotated organisms feature table for KT2440, with updated locus tag IDs and gene descriptions </blockquote>
<ins>Outputs:</ins>
<blockquote>
-{output_filename}.csv is a csv file that modifies the _summary.csv file generated from the 6_Fitness_Compare function to include four identifier. Columns: ‘old_locus_tag’, ‘new_locus_tag’, ‘gene_name’, and ‘description’ </blockquote>
	
10_heatmap.py— This code was written by Andrew J. Borchert (NREL). <br>
<ins>Usage:</ins>
<blockquote>
python3 10_heatmap.py {PATH/Included_Genes_List_File.csv} {PATH_to_Annoted_File} {kwargs} <br>
Pay notice to the code at Lines 71 and 123, since if your input file isn't named appropriately, this function will break. <br>
Note, replicates are added individually as a column is no functionality to use the mean of a particular condition and present it as a column in the heatmap output </blockquote> 
<ins>Input:</ins>
<blockquote>
Included_Genes_List_File -- A file where the first column is a list of genes the user desires to include in the heatmap output. These become row in the heatmap. The second column is a list of conditions files to include in the heatmap output as columns. Note, this abstracts from the Annotated_Summary Files </blockquote>
<ins>Output:</ins>
<blockquote>
heatmap_'Genes_n_Conditions_Filename'-- A heatmap file where columns are the input conditions (and the comparison condition) and rows are the input genes for analysis </blockquote>
	
11_2D_Graph.py—This code was written by Andrew J. Borchert (NREL). <br>
<ins>Usage:</ins>
<blockquote>
python3 PATH/11_2D_Graph.py {PATH/Annotated_Summary.csv} {kwargs} </blockquote>
<ins>Input:</ins>
<blockquote>
Annotated_Summary.csv- File generated as output from the 9_Summary_annotate.py function </blockquote>
<ins>Output:</ins>
<blockquote>
'Annotated_Summary_identifier'_<q_val_cutoff>.pdf -- PDF of a scatterplot named according to the name of the Annotated_Summary file used as input, where the q value cutoff used to flag significant genes is also provided in the title. </blockquote>

## LEGAL 
Copyright (C) 2022 Alliance for Sustainable Energy, LLC All rights reserved.
	
This program is free software; you can redistribute it and/or modify it under 
the terms of the GNU General Public License as published by the Free Software 
Foundation; either version 3 of the License, or (at your option) any later version.
	
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
See the GNU General Public License for more details.
	
Find a copy of the GNU General Public License along with this program. Also see https://www.gnu.org/licenses/gpl-3.0.html

Disclaimer
NEITHER THE UNITED STATES NOR THE UNITED STATES DEPARTMENT OF ENERGY, NOR ANY OF THEIR EMPLOYEES, MAKES ANY WARRANTY, EXPRESS OR IMPLIED, OR ASSUMES ANY LEGAL LIABILITY OR RESPONSIBILITY FOR THE ACCURACY, COMPLETENESS, OR USEFULNESS OF ANY INFORMATION, APPARATUS, PRODUCT, OR PROCESS DISCLOSED, OR REPRESENTS THAT ITS USE WOULD NOT INFRINGE PRIVATELY OWNED RIGHTS.
